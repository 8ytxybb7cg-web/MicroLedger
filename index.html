<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>å°æ•¸ç°¿ Micro Ledger</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* =========================================
           ğŸ¨ iOS 26 ç»ç’ƒæ“¬æ…‹è¨­è¨ˆç³»çµ± (Design System)
           ========================================= */
        :root {
            --bg-color: #050505;
            --accent-color: #0A84FF; /* iOS Blue */
            --success-color: #30D158; /* iOS Green */
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.6);
            
            /* ç»ç’ƒè³ªæ„Ÿè®Šæ•¸ */
            --glass-bg: rgba(30, 30, 40, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-blur: 25px;
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            
            /* åœ“è§’èˆ‡é–“è· */
            --radius-xl: 28px;
            --radius-lg: 18px;
            --radius-md: 12px;
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden; /* Intro æœŸé–“ç¦æ­¢æ»¾å‹• */
            height: 100vh;
        }

        /* å‹•æ…‹æµå…‰èƒŒæ™¯ (Ambient Background) */
        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at 10% 20%, rgba(20, 40, 80, 0.4) 0%, transparent 40%),
                        radial-gradient(circle at 90% 80%, rgba(60, 20, 60, 0.3) 0%, transparent 40%);
            z-index: -1;
            animation: breathe 10s infinite alternate ease-in-out;
        }

        @keyframes breathe {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        /* æ•¸å­—å°ˆç”¨å­—é«” */
        .mono-num {
            font-family: 'JetBrains Mono', monospace;
        }

        /* =========================================
           ğŸš€ Intro Loading é«”é©— (Splash Screen)
           ========================================= */
        #intro-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(5, 5, 5, 0.8);
            backdrop-filter: blur(40px); /* é‡åº¦æ¨¡ç³Š */
            z-index: 9999;
            transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1), backdrop-filter 0.8s ease;
        }

        #intro-layer.fade-out {
            opacity: 0;
            backdrop-filter: blur(0px);
            pointer-events: none;
        }

        .intro-content {
            width: 80%;
            max-width: 320px;
            text-align: center;
        }

        /* å“ç‰Œ Logo/æ¨™é¡Œ */
        .app-title {
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 2px;
            margin-bottom: 60px;
            opacity: 0;
            animation: fadeInUp 0.8s ease forwards;
            background: linear-gradient(135deg, #fff 0%, #aaa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ç‹€æ…‹æ–‡å­—å®¹å™¨ */
        .status-text-container {
            height: 24px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .status-text {
            font-size: 14px;
            color: var(--text-secondary);
            position: absolute;
            width: 100%;
            left: 0;
            top: 0;
            transition: opacity 0.4s ease, transform 0.4s ease;
            opacity: 0;
            transform: translateY(10px);
        }

        .status-text.active {
            opacity: 1;
            transform: translateY(0);
        }

        .status-text.exit {
            opacity: 0;
            transform: translateY(-10px);
        }

        /* ç»ç’ƒå°è»Œé€²åº¦æ¢ */
        .progress-track {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #fff, var(--success-color));
            border-radius: 10px;
            box-shadow: 0 0 10px var(--success-color);
            transition: width 0.1s linear; /* JS æ§åˆ¶å¯¬åº¦ */
        }

        /* =========================================
           ğŸ“± ä¸»æ‡‰ç”¨å®¹å™¨ (Main App Placeholder)
           ========================================= */
        #app-container {
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            padding-top: 60px; /* é¿é–‹é ‚éƒ¨ç‹€æ…‹æ¬„ */
        }

        #app-container.visible {
            opacity: 1;
            transform: scale(1);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>

    <div class="ambient-bg"></div>

    <div id="intro-layer">
        <div class="intro-content">
            <div class="app-title">å°æ•¸ç°¿</div>
            
            <div class="status-text-container">
                <div class="status-text" id="text-1">æ•´ç†æ¯ä¸€ç­†å°æ•¸ä¸­</div>
                <div class="status-text" id="text-2">é€ç­†æ ¸å°ï¼Œè«‹ç¨å€™</div>
                <div class="status-text" id="text-3">è¨ˆç®—ä¸­ï¼Œå””æ€¥</div>
                <div class="status-text" id="text-4">æº–å‚™å°±ç·’</div>
            </div>

            <div class="progress-track">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>
    </div>

    <div id="app-container">
        <h1 style="text-align: center; font-weight: 300;">Micro Ledger</h1>
        <p style="text-align: center; color: var(--text-secondary);">Waiting for data module...</p>
    </div>

    <script>
        // =========================================
        // 1. Supabase åˆå§‹åŒ– (ä½¿ç”¨ä½ çš„ Credentials)
        // =========================================
        const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuYQVvKi'; // é€™è£¡æ”¾ Public Key æ²’å•é¡Œ
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // =========================================
        // 2. Intro Loading é‚è¼¯æ§åˆ¶å™¨
        // =========================================
        const introState = {
            progress: 0,
            targetPhase: 90, // ç¬¬ä¸€éšæ®µç›®æ¨™æ˜¯ 90%
            isAppReady: false // æ¨™è¨˜æ•¸æ“šæ˜¯å¦åŠ è¼‰å®Œæˆ
        };

        const els = {
            layer: document.getElementById('intro-layer'),
            bar: document.getElementById('progress-bar'),
            texts: [
                document.getElementById('text-1'),
                document.getElementById('text-2'),
                document.getElementById('text-3'),
                document.getElementById('text-4')
            ],
            app: document.getElementById('app-container')
        };

        // æ–‡æ¡ˆåˆ‡æ› helper
        function showText(index) {
            els.texts.forEach((el, i) => {
                if (i === index) {
                    el.classList.add('active');
                    el.classList.remove('exit');
                } else if (el.classList.contains('active')) {
                    el.classList.add('exit');
                    el.classList.remove('active');
                }
            });
        }

        // å•Ÿå‹•é–‹å ´å‹•ç•«
        function startIntro() {
            showText(0); // é¡¯ç¤º "æ•´ç†æ¯ä¸€ç­†å°æ•¸ä¸­"
            
            let lastTime = performance.now();

            function tick(currentTime) {
                const dt = currentTime - lastTime;
                lastTime = currentTime;

                // --- éšæ®µ 1: 0% -> 70% (å¿«é€Ÿ) ---
                if (introState.progress < 70) {
                    // é€Ÿåº¦: æ¯æ¯«ç§’ç´„ 0.1% (800ms è·‘å®Œ 70% å·¦å³)
                    introState.progress += dt * 0.12; 
                } 
                // --- éšæ®µ 2: 70% -> 90% (æ”¾æ…¢) ---
                else if (introState.progress < 90) {
                    showText(1); // "é€ç­†æ ¸å°ï¼Œè«‹ç¨å€™"
                    // é€Ÿåº¦: è®Šæ…¢ 
                    introState.progress += dt * 0.04;
                }
                // --- éšæ®µ 3: 90% åœç•™ (ç­‰å¾…æ•¸æ“š) ---
                else if (introState.progress >= 90 && !introState.isAppReady) {
                    introState.progress = 90; // å¼·åˆ¶é–å®š
                    showText(2); // "è¨ˆç®—ä¸­ï¼Œå””æ€¥"
                }
                // --- éšæ®µ 4: è¡åˆº 100% (æ•¸æ“šå›ä¾†äº†) ---
                else if (introState.isAppReady && introState.progress < 100) {
                    introState.progress += dt * 0.5; // æ¥µé€Ÿå®Œæˆ
                }

                // æ¸²æŸ“é€²åº¦æ¢
                els.bar.style.width = Math.min(introState.progress, 100) + '%';

                // æª¢æŸ¥æ˜¯å¦çµæŸ
                if (introState.progress >= 100) {
                    finishIntro();
                } else {
                    requestAnimationFrame(tick);
                }
            }

            requestAnimationFrame(tick);
        }

        // çµæŸå‹•ç•«
        function finishIntro() {
            showText(3); // "æº–å‚™å°±ç·’" (ä¸€é–ƒè€Œé)
            
            setTimeout(() => {
                els.layer.classList.add('fade-out'); // ç»ç’ƒéœ§æ°£æ•£å»
                els.app.classList.add('visible'); // ä¸»ç¨‹å¼æµ®ç¾
                document.body.style.overflow = 'auto'; // æ¢å¾©æ»¾å‹•
            }, 200);
        }

<script>
    // =========================================
    // ğŸ›ï¸ æ•¸æ“šå¼•æ“ (Part 2: Data & Calculation)
    // =========================================

    const AppEngine = {
        // å…¨å±€æ•¸æ“šå­˜å„²
        data: {
            loans: [],      // åŸå§‹å€Ÿè²¸ç´€éŒ„
            summary: {      // ç¸½çµç®—æ•¸æ“š
                totalPrincipal: 0,
                totalInterest: 0,
                totalBalance: 0,
                nextRolloverDate: null
            }
        },

        // é‡‘ç®¡å±€ API é…ç½®
        hkmaConfig: {
            baseUrl: 'https://api.hkma.gov.hk/public/market-data-and-statistics/daily-monetary-statistics/daily-figures-interbank-liquidity',
            segment: 'hibor'
        },

        // ------------------------------------------------
        // 1. æ ¸å¿ƒå•Ÿå‹•å…¥å£
        // ------------------------------------------------
        async init() {
            console.log("ğŸš€ AppEngine Starting...");
            
            try {
                // A. æŠ“å–æ‰€æœ‰å€Ÿè²¸ç´€éŒ„
                const { data: loans, error } = await supabase
                    .from('loan_records')
                    .select('*')
                    .order('transaction_date', { ascending: true });

                if (error) throw error;
                this.data.loans = loans;

                // B. ç‚ºæ¯ä¸€ç­†è²¸æ¬¾è¨ˆç®—è¤‡åˆ© (é€™æ˜¯æœ€è€—æ™‚çš„æ­¥é©Ÿ)
                // æˆ‘å€‘ä½¿ç”¨ Promise.all ä¸¦è¡Œè™•ç†ï¼Œä½†ç‚ºäº† Loading é«”é©—ï¼Œé€™è£¡å…¶å¯¦å¾ˆå¿«
                await this.processAllLoans();

                // C. è¨ˆç®—ç¸½çµæ•¸æ“š
                this.calculateSummary();

                console.log("âœ… Data Ready:", this.data);

                // D. é€šçŸ¥ Intro å‹•ç•«ï¼šæ•¸æ“šæº–å‚™å¥½äº†ï¼
                // é€™æœƒè§¸ç™¼ Part 1 çš„ Loading Bar å¾ 90% è¡åˆºåˆ° 100%
                introState.isAppReady = true;

            } catch (err) {
                console.error("âŒ Initialization Failed:", err);
                alert("æ•¸æ“šåŠ è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£ç·šã€‚");
            }
        },

        // ------------------------------------------------
        // 2. åˆ©ç‡æŠ“å–é‚è¼¯ (Smart Fetch)
        // ç­–ç•¥ï¼šCache (Supabase) -> API (HKMA) -> Fallback
        // ------------------------------------------------
        async getHiborRate(dateStr) {
            // æ­¥é©Ÿ 1: å…ˆæª¢æŸ¥ Supabase ç·©å­˜è¡¨
            const { data: cache } = await supabase
                .from('hibor_cache')
                .select('rate_value')
                .eq('rate_date', dateStr)
                .single();

            if (cache) {
                // console.log(`[Cache Hit] ${dateStr}: ${cache.rate_value}%`);
                return cache.rate_value;
            }

            // æ­¥é©Ÿ 2: ç·©å­˜æ²’æœ‰ï¼Œå‘¼å«é‡‘ç®¡å±€ API
            // console.log(`[API Fetch] Fetching HIBOR for ${dateStr}...`);
            const rate = await this.fetchFromHKMA(dateStr);

            // æ­¥é©Ÿ 3: å¯«å…¥ç·©å­˜ (éé˜»å¡å¼ï¼Œè®“å®ƒåœ¨èƒŒæ™¯å­˜å°±å¥½)
            if (rate !== null) {
                supabase.from('hibor_cache').insert([{ rate_date: dateStr, rate_value: rate }]).then();
            }

            // å¦‚æœé‚£å¤©æ˜¯å‡æœŸæŠ“ä¸åˆ° (return null)ï¼Œæˆ‘å€‘æš«æ™‚ç”¨ "å‰ä¸€å¤©çš„æ•¸æ“š" æ›¿ä»£çš„ç°¡æ˜“é‚è¼¯
            // é€™è£¡ç‚ºäº†ç©©å®šæ€§ï¼Œå¦‚æœçœŸæŠ“ä¸åˆ°ï¼Œé è¨­è¿”å›ä¸€å€‹ä¿å®ˆå€¼ (ä¾‹å¦‚ 4.0%)ï¼Œé¿å…è¨ˆç®—å´©æ½°
            return rate !== null ? rate : 4.0; 
        },

        async fetchFromHKMA(dateStr) {
            // æ ¼å¼åŒ–æ—¥æœŸçµ¦ API (YYYY-MM-DD)
            // HKMA API æ¥å—ç‰¹å®šæ ¼å¼ï¼Œæˆ‘å€‘é€™è£¡æŠ“å–®æ—¥
            const url = `${this.hkmaConfig.baseUrl}?segment=hibor&date=${dateStr}`;
            
            try {
                const response = await fetch(url);
                const json = await response.json();
                
                if (json.header && json.header.success && json.result && json.result.records) {
                    const records = json.result.records;
                    if (records.length > 0) {
                        // å°‹æ‰¾ '1M' (ä¸€å€‹æœˆ) çš„ HIBOR
                        // API è¿”å›çµæ§‹é€šå¸¸æ˜¯ { end_of_day: '...', ir_1m: 4.12345, ... }
                        // æ³¨æ„ï¼šHKMA æ¬„ä½åç¨±å¯èƒ½æ˜¯ 'ir_1m' æˆ–é¡ä¼¼ï¼Œéœ€æ ¹æ“šå¯¦éš›å›æ‡‰è§£æ
                        // é€™è£¡å‡è¨­æ¬„ä½æ˜¯ standard çš„ 'ir_1m' (Interbank Rate 1 Month)
                        const record = records[0];
                        return record.ir_1m || record.ir_1m_fixing || 0; 
                    }
                }
            } catch (e) {
                console.warn("HKMA API Error:", e);
            }
            return null; // è©²æ—¥ç„¡æ•¸æ“š (å‡æœŸ/é€±æœ«)
        },

        // ------------------------------------------------
        // 3. æ ¸å¿ƒé‹ç®—å¼•æ“ï¼šåˆ©æ»¾åˆ©è¨ˆç®— (Rollover Engine)
        // è¦å‰‡ï¼šHIBOR - 1%ï¼Œæ¯æœˆ 1 è™Ÿçµç®—
        // ------------------------------------------------
        async processAllLoans() {
            const today = new Date();
            
            // å°æ¯ä¸€ç­†è²¸æ¬¾é€²è¡Œéæ­·è¨ˆç®—
            const processedLoans = await Promise.all(this.data.loans.map(async (loan) => {
                let currentPrincipal = parseFloat(loan.principal_amount); // ç•¶å‰æœ¬é‡‘ (æœƒéš¨åˆ©æ¯å¢åŠ )
                let currentDate = new Date(loan.transaction_date);
                let history = []; // è¨˜éŒ„æ¯ä¸€æ¬¡ Rollover çš„ç´°ç¯€ (ç”¨æ–¼å‰ç«¯å±•ç¤º)
                
                // è¿´åœˆï¼šç›´åˆ°è¨ˆç®—åˆ°ä»Šå¤©
                while (currentDate < today) {
                    // A. ç¢ºå®šæœ¬æœŸçµæŸæ—¥ (ä¸‹å€‹æœˆ 1 è™Ÿï¼Œæˆ–æ˜¯ä»Šå¤©)
                    let nextRolloverDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                    
                    // å¦‚æœä¸‹å€‹ 1 è™Ÿå·²ç¶“è¶…éä»Šå¤©ï¼Œå‰‡æœ¬æœŸåªç®—åˆ°ä»Šå¤©
                    if (nextRolloverDate > today) {
                        nextRolloverDate = new Date(today);
                    }

                    // å¦‚æœæ—¥æœŸæ²’è®Š (ä¾‹å¦‚ä»Šå¤©å°±æ˜¯å€Ÿæ¬¾æ—¥)ï¼Œè·³å‡º
                    if (nextRolloverDate <= currentDate) break;

                    // B. æ±ºå®šæœ¬æœŸåˆ©ç‡
                    // è¦å‰‡ï¼šç¬¬ä¸€æœŸç”¨å€Ÿæ¬¾æ—¥ HIBORï¼Œä¹‹å¾Œæ¯ä¸€æœŸç”¨è©²æœŸ "1è™Ÿ" çš„ HIBOR
                    // ç‚ºäº†ç°¡åŒ–ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æœŸ (historyé•·åº¦ç‚º0)ï¼Œç”¨ transaction_date
                    // å¦å‰‡ç”¨ currentDate (å³ä¸Šä¸€æ¬¡çµç®—çš„æ—¥æœŸ)
                    const rateDateStr = currentDate.toISOString().split('T')[0];
                    let rawHibor = await this.getHiborRate(rateDateStr);

                    // --- é—œéµè¦å‰‡ï¼šHIBOR - 1% ---
                    let effectiveRate = Math.max(0, rawHibor - 1); // ç¢ºä¿ä¸ä½æ–¼ 0%
                    
                    // C. è¨ˆç®—å¤©æ•¸
                    const timeDiff = nextRolloverDate - currentDate;
                    const days = Math.ceil(timeDiff / (1000 * 60 * 60 * 24)); // æ¯«ç§’è½‰å¤©æ•¸

                    // D. è¨ˆç®—æœ¬æœŸåˆ©æ¯ (æœ¬é‡‘ * åˆ©ç‡ * å¤©æ•¸ / 365)
                    // åˆ©ç‡æ˜¯å¹´åˆ©ç‡ï¼Œæ‰€ä»¥è¦é™¤ä»¥ 100 è®Šå°æ•¸ï¼Œå†é™¤ä»¥ 365
                    const interest = currentPrincipal * (effectiveRate / 100) * (days / 365);

                    // E. è¨˜éŒ„æ­·ç¨‹
                    history.push({
                        startDate: rateDateStr,
                        endDate: nextRolloverDate.toISOString().split('T')[0],
                        days: days,
                        hibor: rawHibor,
                        rate: effectiveRate,
                        interestEarned: interest,
                        principalBefore: currentPrincipal
                    });

                    // F. æ»¾å­˜ï¼šåˆ©æ¯ä½µå…¥æœ¬é‡‘
                    currentPrincipal += interest;
                    
                    // æ›´æ–°æ—¥æœŸï¼Œæº–å‚™ä¸‹ä¸€è¼ªè¿´åœˆ
                    currentDate = nextRolloverDate;
                }

                // å°‡è¨ˆç®—çµæœæ›è¼‰å› loan ç‰©ä»¶
                loan.calculated = {
                    currentBalance: currentPrincipal,
                    totalInterest: currentPrincipal - loan.principal_amount,
                    history: history,
                    lastRate: history.length > 0 ? history[history.length - 1].rate : 0
                };

                return loan;
            }));

            this.data.loans = processedLoans;
        },

        // ------------------------------------------------
        // 4. ç¸½çµè¨ˆç®—
        // ------------------------------------------------
        calculateSummary() {
            let totalP = 0;
            let totalBal = 0;

            this.data.loans.forEach(loan => {
                if (!loan.is_settled) {
                    totalP += parseFloat(loan.principal_amount);
                    totalBal += loan.calculated.currentBalance;
                }
            });

            this.data.summary = {
                totalPrincipal: totalP,
                totalBalance: totalBal,
                totalInterest: totalBal - totalP,
                // ä¸‹æ¬¡çµç®—æ—¥å›ºå®šç‚ºä¸‹æœˆ 1 è™Ÿ
                nextRolloverDate: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1)
            };
        }
    };

    // =========================================
    // å•Ÿå‹•å¼•æ“
    // =========================================
    // é€™è£¡æˆ‘å€‘æ›¿æ›æ‰ Part 1 çš„ setTimeout æ¨¡æ“¬
    // ç•¶é é¢åŠ è¼‰å®Œæˆå¾Œï¼Œç«‹å³å•Ÿå‹• AppEngine
    window.addEventListener('DOMContentLoaded', () => {
        // å…ˆè®“ Intro å‹•ç•«è·‘ä¸€ä¸‹ (è‡³å°‘è·‘å€‹ 0.5 ç§’è®“ç”¨æˆ¶çœ‹åˆ° Logo)ï¼Œå†é–‹å§‹æŠ“æ•¸æ“š
        setTimeout(() => {
            AppEngine.init(); 
        }, 500); 
    });

</script>
</body>
</html>
